<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Okakoro Traker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
        }

        .info-box {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #4CAF50;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
</head>

<body>
    <div class="container py-5">
       <!-- <h2 class="text-center mb-4">üìç Ubicaci√≥n en Tiempo Real + Control Relay</h2>-->
        <div id="map"></div>

        <div class="info-box text-center">
            <h5>Coordenadas actuales:</h5>
            <p><strong>Latitud:</strong> <span id="lat">--</span></p>
            <p><strong>Longitud:</strong> <span id="lng">--</span></p>
        </div>

        <div class="text-center mt-4">
            <h5>Corta Corriente:</h5>
            <label class="switch">
                <input type="checkbox" id="relaySwitch" onchange="toggleRelay()">
                <span class="slider"></span>
            </label>
            <div class="mt-2">
                <span id="relayState">Desconocido</span>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBukTLs8YHWCtf6lZuLixcFi5T2f2Yuriw"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCwYMYdSWzHCsvWPK1o1kE8DHBy2QjinSc",
            authDomain: "okakoro-8d8eb.firebaseapp.com",
            databaseURL: "https://okakoro-8d8eb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "okakoro-8d8eb",
            storageBucket: "okakoro-8d8eb.firebasestorage.app",
            messagingSenderId: "923367505708",
            appId: "1:923367505708:web:cd6892926f2797eb32f689"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let map, marker;

        function initMap(lat, lng) {
            const pos = { lat, lng };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 18,
                center: pos
            });
            marker = new google.maps.Marker({
                position: pos,
                map: map,
                animation: google.maps.Animation.DROP,
                title: "Ubicaci√≥n actual"
            });
        }

        function actualizarUbicacion(lat, lng) {
            const pos = { lat, lng };
            marker.setPosition(pos);
            map.setCenter(pos);
            document.getElementById("lat").textContent = lat.toFixed(6);
            document.getElementById("lng").textContent = lng.toFixed(6);
        }

        db.ref("gps").on("value", snapshot => {
            const data = snapshot.val();
            if (data && data.latitud && data.longitud) {
                const lat = parseFloat(data.latitud);
                const lng = parseFloat(data.longitud);

                if (!map) {
                    initMap(lat, lng);
                } else {
                    actualizarUbicacion(lat, lng);
                }
            }
        });

        db.ref("relay/estado").on("value", snapshot => {
            const estado = snapshot.val();
            const switchElement = document.getElementById('relaySwitch');
            const stateText = document.getElementById('relayState');

            if (estado === "encender") {
                switchElement.checked = true;
                stateText.textContent = "Encendido";
            } else if (estado === "apagar") {
                switchElement.checked = false;
                stateText.textContent = "Apagado";
            }
        });

        function toggleRelay() {
            const isChecked = document.getElementById('relaySwitch').checked;
            const comando = isChecked ? "encender" : "apagar";
            firebase.database().ref("relay/estado").set(comando)
                .then(() => console.log("‚úÖ Relay: " + comando))
                .catch(err => console.error("‚ùå Error:", err));
        }
    </script>
</body>

</html>
